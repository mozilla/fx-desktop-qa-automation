---
name: DTE Automation Dispatch

run-name: CI tests kicked off by ${{ github.actor }}
on:
  pull_request:

  workflow_dispatch:
    inputs:
      preview_only:
        description: "If true, only show which jobs would run (no reusable workflows called)"
        required: false
        default: "true"
      dry_run:
        description: "If true, downstream workflows should avoid side-effects (publish/deploy)"
        required: false
        default: "true"
      win_installer_link:
        description: "Optional Windows installer link to forward to the test workflow"
        required: false
        type: string
      mac_installer_link:
        description: "Optional macOS installer link to forward to the test workflow"
        required: false
        type: string
      linux_tarball_link:
        description: "Optional Linux tarball link to forward to the test workflow"
        required: false
        type: string

permissions:
  contents: "write"

jobs:
  Select-Channels:
    runs-on: ubuntu-latest
    outputs:
      channels: ${{ steps.dispatch.outputs.channels }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Select test channels
        id: dispatch
        run: |
          python3 scripts/choose_test_channel.py
          echo channels=$(python3 scripts/choose_test_channel.py) >> "$GITHUB_OUTPUT"

  Preview-Plan:
    # Only run preview when triggered manually via workflow_dispatch and preview_only set to true
    needs: Select-Channels
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true' }}
    steps:
      - name: Show selected channels
        run: |
          echo "selected channels are: ${{ needs.Select-Channels.outputs.channels }}"
      - name: Print planned jobs
        run: |
          python3 - <<'PY'
          import json, os
          raw = os.environ.get('SELECT_CHANNELS', '${{ needs.Select-Channels.outputs.channels }}')
          # The output is expected to be JSON array or stringified JSON; try to parse
          try:
              channels = json.loads(raw)
          except Exception:
              # fallback: try to evaluate simple comma separated string
              channels = [x.strip() for x in raw.strip("[] \n'\"").split(",") if x.strip()]
          print("Channels:", channels)
          planned = []
          if any('starfox' in str(c) for c in channels):
              planned += ["Run-Starfox-Win (Test-Windows)", "Run-Starfox-Mac (Test-MacOS)"]
          if any('l10n' in str(c) for c in channels):
              planned += ["Run-L10n-Win (L10n-Windows)", "Run-L10n-Mac (L10n-MacOS)", "Run-L10n-Linux (L10n-Linux)"]
          if not planned:
              print("No jobs selected by channels.")
          else:
              print("Planned jobs (no workflows executed):")
              for p in planned:
                  print(" -", p)
          PY
                  env:
                    SELECT_CHANNELS: ${{ needs.Select-Channels.outputs.channels }}

  Run-Starfox-Win:
    needs: Select-Channels
    # skip this job in preview_only mode
    if: ${{ contains(fromJSON(needs.Select-Channels.outputs.channels), 'starfox') &&
      !(github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true')
    }}
    uses: ./.github/workflows/main.yml
    with:
      job_to_run: Test-Windows
      is_pull_request: true
      # pass the value of dry_run down the pipeline
      dry_run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets: inherit

  Run-Starfox-Mac:
    needs: Select-Channels
    if: ${{ contains(fromJSON(needs.Select-Channels.outputs.channels), 'starfox') &&
      !(github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true')
    }}
    uses: ./.github/workflows/main.yml
    with:
      job_to_run: Test-MacOS
      is_pull_request: true
      dry_run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets: inherit

  Run-L10n-Win:
    needs: Select-Channels
    if: ${{ contains(fromJSON(needs.Select-Channels.outputs.channels), 'l10n') &&
      !(github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true')
    }}
    uses: ./.github/workflows/main-l10n.yml
    with:
      job_to_run: L10n-Windows
      is_pull_request: true
      dry_run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets: inherit

  Run-L10n-Mac:
    needs: Select-Channels
    if: ${{ contains(fromJSON(needs.Select-Channels.outputs.channels), 'l10n') &&
      !(github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true')
    }}
    uses: ./.github/workflows/main-l10n.yml
    with:
      job_to_run: L10n-MacOS
      is_pull_request: true
      dry_run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets: inherit

  Run-L10n-Linux:
    needs: Select-Channels
    if: ${{ contains(fromJSON(needs.Select-Channels.outputs.channels), 'l10n') &&
      !(github.event_name == 'workflow_dispatch' && github.event.inputs.preview_only == 'true')
    }}
    uses: ./.github/workflows/main-l10n.yml
    with:
      job_to_run: L10n-Linux
      is_pull_request: true
      dry_run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets: inherit
